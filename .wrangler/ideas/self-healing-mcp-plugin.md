# Idea: Self-Healing MCP Plugin Architecture

**Status**: Brainstorming
**Created**: 2025-11-18
**Category**: Plugin Architecture, Self-Improvement

---

## Core Concept

Bundle the MCP server codebase directly into the wrangler plugin distribution, enabling the plugin to automatically detect, diagnose, and fix its own bugs through an AI-driven workflow that creates PRs for maintainer review.

## Problem Statement

**Current Pain Points**:
1. **Bug Discovery Delay**: Users encounter MCP bugs, but fixes require maintainer intervention
2. **Debugging Friction**: When MCP tools fail, users can't see or modify the source code
3. **Feedback Loop**: No automated path from "bug detected" â†’ "fix proposed" â†’ "fix merged"
4. **Code Isolation**: MCP code lives separately from project, making debugging harder
5. **Update Lag**: Even if bug is known, users must wait for plugin update

**What if**: The plugin could fix itself, learn from errors, and propose improvements automatically?

## Proposed Solution

### Architecture: Bundled MCP Source Code

**Plugin Distribution Structure**:
```
.claude-plugin/
â”œâ”€â”€ plugin.json
â”œâ”€â”€ skills/
â”‚   â”œâ”€â”€ [36 existing skills...]
â”‚   â””â”€â”€ mcp-self-healing/
â”‚       â”œâ”€â”€ SKILL.md                    # Self-healing workflow
â”‚       â””â”€â”€ diagnose-and-fix.md         # Diagnostic procedures
â”œâ”€â”€ mcp/                                 # â† NEW: Full MCP source
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ server.ts
â”‚   â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â””â”€â”€ types/
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â””â”€â”€ README.md
â””â”€â”€ commands/
    â””â”€â”€ fix-mcp-error.md                # â† NEW: Self-healing trigger
```

**Benefits**:
- Users can inspect MCP source when debugging
- Plugin has access to its own codebase
- Can clone, modify, test, and PR fixes
- Self-contained debugging environment

### Workflow: Self-Healing MCP Errors

**Trigger**: MCP tool error detected (via error response or user report)

**Phases**:

#### Phase 1: Error Detection & Diagnosis

```
MCP Tool Error Detected
    â†“
Capture Error Context:
  - Tool name (e.g., issues_create)
  - Error message
  - Input parameters
  - Stack trace
  - Recent code changes (git log)
    â†“
Run Diagnostic Checks:
  - Is error reproducible?
  - Is it a known issue? (check .wrangler/mcp-known-issues.json)
  - TypeScript compilation errors?
  - Test failures?
  - Schema validation issues?
    â†“
Classify Error:
  - BUG: Logic error in tool implementation
  - REGRESSION: Recent change broke functionality
  - CONFIG: Misconfiguration (not code bug)
  - UPSTREAM: External dependency issue
```

#### Phase 2: Automated Fix Workflow

**If Classified as BUG or REGRESSION**:

```markdown
## Self-Healing Workflow

### Step 1: Clone MCP Codebase to Workspace
- Create `.wrangler/cache/mcp-fix-{timestamp}/`
- Git clone plugin MCP directory to workspace
- Create fix branch: `fix/auto-{error-summary}-{timestamp}`

### Step 2: Root Cause Analysis
- Use systematic-debugging skill
- Read relevant source files (server.ts, tool implementation)
- Review tests for affected tool
- Identify exact line(s) causing error

### Step 3: Implement Fix
- Write failing test FIRST (TDD)
- Implement minimal fix to pass test
- Ensure no regressions (run full test suite)
- Update types/schemas if needed

### Step 4: Verification
- Run `npm test` - all tests must pass
- Run `npm run build` - must compile cleanly
- Test fix against original error scenario
- Check test coverage (must maintain >80%)

### Step 5: Create Pull Request
- Commit changes with detailed message:
  ```
  fix: [tool name] - [error summary]

  Root cause: [explanation]
  Fix: [what changed]
  Testing: [verification performed]

  Auto-generated by wrangler self-healing workflow
  Error timestamp: {timestamp}
  ```
- Push to remote fork (or add to plugin repo if write access)
- Use `gh pr create` to create PR with:
  - Title: "ðŸ¤– Self-Healing: Fix {tool} {error}"
  - Body: Detailed RCA + fix explanation
  - Labels: `auto-fix`, `mcp`, `{tool-name}`

### Step 6: User Notification & Tracking
- Create TODO in project:
  ```
  [ ] Review auto-generated MCP fix PR #{pr_number}
      Tool: {tool_name}
      Error: {summary}
      PR: {url}
      Created: {timestamp}
  ```
- Add to `.wrangler/mcp-pending-fixes.json`:
  ```json
  {
    "fixes": [
      {
        "prNumber": 123,
        "tool": "issues_create",
        "error": "fs.writeFile is not a function",
        "timestamp": "2025-11-18T10:30:00Z",
        "status": "pending_review",
        "localFixPath": ".wrangler/cache/mcp-fix-1234567890"
      }
    ]
  }
  ```
```

#### Phase 3: Temporary Workaround (Optional)

**While PR is pending**:
- Apply fix locally to `.wrangler/cache/mcp-patched/`
- Update plugin.json to point to patched MCP server
- User can use fixed version immediately
- When PR merged + plugin updated, revert to official version

### Skill: `mcp-self-healing`

**Location**: `skills/mcp-self-healing/SKILL.md`

**Purpose**: Automatically detect, diagnose, and fix MCP bugs through TDD workflow with PR submission

**Trigger**:
- User encounters MCP error
- User runs `/fix-mcp-error {error-description}`
- Automatic detection via error monitoring

**Workflow**:
1. **Diagnose**: Systematic debugging to find root cause
2. **Clone**: Create workspace in `.wrangler/cache/mcp-fix-{timestamp}/`
3. **Fix**: TDD approach (write test, implement fix, verify)
4. **PR**: Submit to plugin repository with detailed explanation
5. **Track**: Add TODO for maintainer review
6. **Patch** (optional): Apply local fix while PR pending

**Output**:
- Pull request URL
- Local fix location (if patched)
- TODO reminder for review
- Verification report

**Constitutional Alignment**:
- âœ… Test-Driven Development (write test first)
- âœ… Systematic over ad-hoc (defined workflow)
- âœ… Evidence over claims (run tests, verify fix)
- âœ… Complexity reduction (automate bug fixing)

### Command: `/fix-mcp-error`

**Usage**: `/fix-mcp-error [error-description]`

**Example**:
```
User: /fix-mcp-error issues_create fails with "fs.writeFile is not a function"

Agent: I'll diagnose and fix this MCP error.

[Runs mcp-self-healing skill]

âœ… Diagnosis complete:
   - Tool: issues_create
   - Root cause: mcp/providers/markdown.ts:234 uses fs.writeFile instead of fs-extra writeFile
   - Error type: BUG (missing import)

ðŸ”§ Implementing fix:
   1. Created workspace: .wrangler/cache/mcp-fix-1731916200/
   2. Wrote failing test
   3. Fixed import in markdown.ts
   4. All 233 tests passing âœ…

ðŸ“¤ Pull Request Created:
   PR #47: ðŸ¤– Self-Healing: Fix issues_create fs.writeFile error
   URL: https://github.com/wrangler-marketplace/wrangler/pull/47

âœ… TODO Added:
   [ ] Review auto-generated MCP fix PR #47

Would you like me to apply the fix locally while PR is pending?
```

---

## Technical Implementation Details

### 1. Plugin Distribution Changes

**Current**: Plugin distributes compiled MCP server only
```
.claude-plugin/
â””â”€â”€ mcp/
    â””â”€â”€ dist/          # Compiled JS only
```

**Proposed**: Plugin distributes full source + tests
```
.claude-plugin/
â””â”€â”€ mcp/
    â”œâ”€â”€ src/           # Full TypeScript source
    â”œâ”€â”€ tests/         # Test suite
    â”œâ”€â”€ dist/          # Compiled output
    â”œâ”€â”€ package.json
    â””â”€â”€ tsconfig.json
```

**Size Impact**: ~500KB additional (source + tests)

### 2. Self-Healing Workspace Structure

```
.wrangler/
â”œâ”€â”€ cache/
â”‚   â””â”€â”€ mcp-fixes/
â”‚       â”œâ”€â”€ fix-1731916200/              # Timestamped fix workspace
â”‚       â”‚   â”œâ”€â”€ .git/                    # Local git repo
â”‚       â”‚   â”œâ”€â”€ src/                     # Cloned MCP source
â”‚       â”‚   â”œâ”€â”€ tests/                   # Cloned tests
â”‚       â”‚   â””â”€â”€ fix-summary.json         # Metadata
â”‚       â””â”€â”€ patched-mcp/                 # Active patched version (optional)
â”‚           â””â”€â”€ dist/                    # Compiled with local fixes
â”‚
â”œâ”€â”€ mcp-pending-fixes.json               # Track pending PRs
â””â”€â”€ mcp-known-issues.json                # Known bug catalog
```

### 3. Error Detection Integration

**Hook into MCP Error Responses**:

```typescript
// In mcp/server.ts
async handleToolCall(request: ToolCallRequest): Promise<CallToolResult> {
  try {
    const result = await this.executeTool(request);
    return result;
  } catch (error) {
    // Log error for potential self-healing
    await this.logErrorForSelfHealing({
      tool: request.name,
      params: request.arguments,
      error: error,
      timestamp: Date.now()
    });

    return createErrorResponse(
      MCPErrorCode.TOOL_EXECUTION_ERROR,
      error.message,
      { suggestFix: true }  // â† Signal that /fix-mcp-error available
    );
  }
}
```

**Error Log Format** (`.wrangler/mcp-error-log.jsonl`):
```jsonl
{"tool":"issues_create","error":"fs.writeFile is not a function","timestamp":1731916200,"params":{...},"stackTrace":"..."}
{"tool":"issues_search","error":"undefined query","timestamp":1731916300,"params":{...},"stackTrace":"..."}
```

### 4. Diagnostic Procedures

**Skill includes systematic diagnostics**:

```markdown
## Diagnostic Checklist

### 1. Reproduce Error
- [ ] Re-run failing MCP tool with same parameters
- [ ] Confirm error still occurs
- [ ] Capture full error message + stack trace

### 2. Check Recent Changes
- [ ] Git log last 10 commits
- [ ] Identify if regression (was it working before?)
- [ ] Check if related to recent plugin update

### 3. TypeScript Compilation
- [ ] Run `npm run build` in MCP directory
- [ ] Check for type errors
- [ ] Verify tsconfig.json is valid

### 4. Test Suite
- [ ] Run `npm test` - identify failing tests
- [ ] Check if test exists for failing tool
- [ ] Review test coverage for affected code

### 5. Schema Validation
- [ ] Check Zod schema for tool
- [ ] Verify input params match schema
- [ ] Test schema with sample data

### 6. Dependencies
- [ ] Check package.json for missing deps
- [ ] Verify all imports resolve
- [ ] Check for version mismatches

### 7. Provider Layer
- [ ] If file operation failed, check markdown provider
- [ ] Verify path resolution
- [ ] Check file permissions

### 8. Classify Error
Based on diagnostics, classify as:
- BUG: Code logic error â†’ Fix with PR
- REGRESSION: Recent change broke it â†’ Bisect + fix
- CONFIG: User misconfiguration â†’ Document fix
- UPSTREAM: External dependency â†’ Report upstream
- INVALID: User error â†’ Document correct usage
```

### 5. PR Creation Automation

**Use GitHub CLI (`gh`)**:

```bash
# In self-healing workflow
cd .wrangler/cache/mcp-fixes/fix-{timestamp}

# Create fix branch
git checkout -b fix/auto-{tool}-{error-slug}

# Make changes (via TDD)
# ... fix implementation ...

# Commit
git add .
git commit -m "fix: {tool} - {error summary}

Root cause: {detailed explanation}

Fix: {what changed and why}

Testing: {verification steps}
- Wrote failing test in tests/tools/{tool}.test.ts
- Implemented fix in src/tools/{tool}.ts
- All 233 tests passing
- Coverage maintained at >80%

Auto-generated by wrangler self-healing workflow
Error timestamp: {timestamp}
Original error: {full error message}
"

# Push to fork (or plugin repo if contributor)
git push origin fix/auto-{tool}-{error-slug}

# Create PR
gh pr create \
  --title "ðŸ¤– Self-Healing: Fix {tool} {error summary}" \
  --body "$(cat PR_TEMPLATE.md)" \
  --label "auto-fix,mcp,{tool}" \
  --assignee "{maintainer}"
```

**PR Template** (auto-generated):
```markdown
## Summary

Automatically detected and fixed bug in `{tool}` tool.

## Error Details

- **Tool**: `{tool_name}`
- **Error**: `{error_message}`
- **Timestamp**: {timestamp}
- **User Impact**: {description}

## Root Cause Analysis

{detailed RCA from systematic debugging}

## Fix Implementation

{explanation of changes}

### Changed Files
- `src/tools/{tool}.ts` - {changes}
- `tests/tools/{tool}.test.ts` - {new test}

## Testing

- âœ… Wrote failing test reproducing error
- âœ… Implemented minimal fix
- âœ… All 233 tests passing
- âœ… Coverage: {percentage}%
- âœ… TypeScript compilation: success
- âœ… Verified against original error scenario

## Verification Steps for Reviewer

1. Checkout branch: `git checkout fix/auto-{tool}-{error-slug}`
2. Run tests: `npm test`
3. Build: `npm run build`
4. Review changes in `src/tools/{tool}.ts`

## Auto-Generated

This PR was created by wrangler's self-healing workflow.

- Workflow: `skills/mcp-self-healing/SKILL.md`
- Command: `/fix-mcp-error`
- User: {project_name}
```

---

## Benefits

### For Users

1. **Immediate Fixes**: Don't wait for maintainer to fix bugs
2. **Transparency**: Can see MCP source code when debugging
3. **Learning**: Understand how tools work by reading source
4. **Contribution**: Plugin helps generate PRs automatically
5. **Reduced Friction**: Bugs don't block progress

### For Maintainers

1. **Higher Quality PRs**: AI follows TDD, writes tests, provides RCA
2. **Faster Bug Discovery**: Users' projects detect bugs in real-time
3. **Reduced Support Load**: Self-healing handles common issues
4. **Better Bug Reports**: Automatic RCA + reproduction steps
5. **Community Scaling**: More users can contribute without knowing codebase

### For Ecosystem

1. **Self-Improving Software**: Plugin gets better over time
2. **Distributed Testing**: Every user project is a test environment
3. **Rapid Iteration**: Bugs detected and fixed within minutes
4. **Knowledge Transfer**: AI learns from fixes, improves diagnostics
5. **Resilience**: Plugin can recover from errors autonomously

---

## Challenges & Mitigations

### Challenge 1: False Positives

**Risk**: Plugin creates PRs for non-bugs (user errors, edge cases)

**Mitigation**:
- Require high-confidence diagnosis before creating PR
- Include "Confidence Level" in PR (HIGH/MEDIUM/LOW)
- Low-confidence fixes go to draft PRs for review
- Learn from rejected PRs (add to known-issues.json)

### Challenge 2: Code Quality

**Risk**: Auto-generated fixes might be suboptimal

**Mitigation**:
- Enforce TDD (test must fail first, then pass)
- Run full test suite (must maintain coverage)
- Use constitutional principles (complexity reduction, etc.)
- Maintainer review before merge (never auto-merge)
- Include rollback instructions

### Challenge 3: Plugin Size

**Risk**: Bundling full source increases plugin size (~500KB)

**Mitigation**:
- Compress source files
- Optional: Download source on-demand (first error only)
- Users can disable self-healing (WRANGLER_DISABLE_SELF_HEALING=true)
- Benefits outweigh size cost for most users

### Challenge 4: Security

**Risk**: Plugin modifying its own code could be exploited

**Mitigation**:
- Self-healing only creates PRs (never auto-merges)
- All changes reviewed by human maintainer
- Fixes isolated in `.wrangler/cache/` (gitignored)
- Optional local patching (user must explicitly enable)
- Code signing for official plugin updates

### Challenge 5: Complexity

**Risk**: Self-healing workflow adds complexity to plugin

**Mitigation**:
- Skill is opt-in (only runs when `/fix-mcp-error` invoked)
- Clear documentation of workflow
- Disable via environment variable
- Graceful degradation if self-healing fails

---

## Implementation Phases

### Phase 1: Bundle MCP Source (v1.2.0)
- Include full MCP source in plugin distribution
- Add README explaining source availability
- No self-healing yet, just transparency

### Phase 2: Error Logging (v1.3.0)
- Add error logging to `.wrangler/mcp-error-log.jsonl`
- Create error dashboard skill (view recent errors)
- Diagnostic procedures documented

### Phase 3: Self-Healing Skill (v1.4.0)
- Implement `skills/mcp-self-healing/SKILL.md`
- Add `/fix-mcp-error` command
- TDD workflow for fix generation
- PR creation automation

### Phase 4: Local Patching (v1.5.0)
- Optional: Apply fixes locally while PR pending
- Patch management in `.wrangler/cache/mcp-patched/`
- Automatic revert when PR merged

### Phase 5: Proactive Detection (v2.0.0)
- Automatic error detection (no command needed)
- AI suggests fixes based on error patterns
- Learning from past fixes

---

## Open Questions

1. **PR Destination**: Should PRs go to main wrangler repo or user's fork?
   - **Option A**: Main repo (requires contributor access)
   - **Option B**: User's fork (user must have GitHub account)
   - **Option C**: Hybrid (try main, fall back to fork)

2. **Approval Flow**: Who approves auto-generated PRs?
   - **Option A**: Maintainer reviews all
   - **Option B**: High-confidence auto-merge after 24h
   - **Option C**: Community vote on auto-fixes

3. **Source Bundling**: Bundle full source or download on-demand?
   - **Option A**: Always bundle (larger plugin, faster fixes)
   - **Option B**: Download on first error (smaller plugin, slower first fix)
   - **Option C**: User preference in settings.json

4. **Fix Scope**: Should self-healing handle only MCP or all plugin code?
   - **Option A**: MCP only (smaller scope, easier to manage)
   - **Option B**: All plugin code (skills, hooks, commands)
   - **Option C**: Configurable (user chooses scope)

5. **Testing**: How to test self-healing workflow?
   - **Option A**: Inject known bugs in test mode
   - **Option B**: Replay historical errors
   - **Option C**: Simulation with mock MCP errors

---

## Success Metrics

**Adoption**:
- % of users with self-healing enabled
- Number of `/fix-mcp-error` invocations
- Number of auto-generated PRs

**Quality**:
- % of auto-generated PRs merged
- Average time from bug report to PR creation
- Test coverage of auto-fixes

**Impact**:
- Reduction in manual bug reports
- Time saved for maintainers
- User satisfaction with self-healing

**Learning**:
- Number of unique bugs fixed automatically
- Repeat bug detection (same bug in multiple projects)
- Improvement in diagnostic accuracy over time

---

## Related Ideas

- **Self-Updating Skills**: Apply same pattern to skills (auto-fix skill bugs)
- **Plugin Marketplace**: Share auto-fixes across wrangler community
- **Error Analytics**: Aggregate error data for proactive improvements
- **AI Training**: Use self-healing corpus to train better debugging AI

---

## References

- Issue #000001: Centralized .wrangler/ directory (provides workspace structure)
- Skill: `systematic-debugging` (diagnostic framework)
- Skill: `test-driven-development` (fix implementation pattern)
- Skill: `sharing-skills` (PR creation workflow)

---

## Next Steps

1. **Validate Concept**: Discuss with maintainers + community
2. **Prototype**: Implement Phase 1 (bundle source) in v1.2.0
3. **Test**: Try manual self-healing workflow on real bug
4. **Iterate**: Refine based on learnings
5. **Automate**: Build full self-healing skill in v1.4.0